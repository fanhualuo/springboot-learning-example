#### Spring Cloud 入门


一，服务注册框架
 服务治理框架有 
 Spring Cloud Eureka 
 Spring Cloud Consul（支持多数据中心） 
 zookeeper 
- 1，服务注册中心 （Spring Cloud Eureka） 
通过@EnableEurekaServer注解启动一个服务注册中心提供给其他应用进行对话。

- 2，服务提供方（生产者） 

- 3，服务消费方（消费者） 
(1)，Spring Cloud Feign 
Spring Cloud Feign是一套基于Netflix Feign实现的声明式服务调用客户端。它使得编写Web服务客户端变得更加简单。我们只需要通过创建接口并用注解来配置它既可完成对Web服务接口的绑定。它具备可插拔的注解支持，包括Feign注解、JAX-RS注解。它也支持可插拔的编码器和解码器。Spring Cloud Feign还扩展了对Spring MVC注解的支持，同时还整合了Ribbon和Eureka来提供均衡负载的HTTP客户端实现。 
(2)，就是可以使用接口编程，和dubbo调用一样 

- 4，Ribbon 
Ribbon是一个基于HTTP和TCP客户端的负载均衡器。Feign中也使用Ribbon，后续会介绍Feign的使用。
可以启动多个同样服务进行注册，然后调用者会轮询对多个生产者进行调用。 

- 5，断路器 
    在微服务架构中，存在着那么多的服务单元，若一个单元出现故障，就会因依赖关系形成故障蔓延，最终导致整个系统的瘫痪，这样的架构相较传统架构就更加的不稳定。为了解决这样的问题，因此产生了断路器模式。 <br>
    断路器模式的作用是，当某个服务单元发生故障（类似用电器发生短路）之后，通过断路器的故障监控（类似熔断保险丝），向调用方返回一个错误响应，而不是长时间的等待。这样就不会使得线程因调用故障服务被长时间占用不释放，避免了故障在分布式系统中的蔓延。 <br>
Netflix Hystrix 
Hystrix具备了服务降级、服务熔断、线程隔离、请求缓存、请求合并以及服务监控等强大功能。 
在Spring Cloud中使用了Hystrix 来实现断路器的功能。Hystrix是Netflix开源的微服务框架套件之一，该框架目标在于通过控制那些访问远程系统、服务和第三方库的节点，从而对延迟和故障提供更强大的容错能力。Hystrix具备拥有回退机制和断路器功能的线程和信号隔离，请求缓存和请求打包，以及监控和配置等功能。 
使用步骤：（只需要修改~~~消费方！！！~~~~，即调用服务的模块） 
(1)，在消费方增加依赖进行断路器支持 
<dependency> 
    <groupId>org.springframework.cloud</groupId> 
    <artifactId>spring-cloud-starter-hystrix</artifactId> 
</dependency> 
(2)，启动类增加注解 
@EnableCircuitBreaker   //@EnableCircuitBreaker注解开启断路器功能
(3)，增加接口的实现类（ClientServiceImpl），进行函数的回调使用
(4)，使用@FeignClient注解中的fallback属性指定回调类
@FeignClient(value = "生产者",fallback = ClientServiceImpl.class)
(5)，application增加 开启断路器
    feign:
      hystrix:
        enabled: true

6，Spring Cloud Config实现了应用多环境的外部化配置以及版本管理
Spring Cloud Config是Spring Cloud团队创建的一个全新项目，用来为分布式系统中的基础设施和微服务应用提供集中化的外部配置支持，它分为服务端与客户端两个部分。

使用步骤
(1)，准备配置仓库，spring cloud config默认为git（可以设置本地文件系统或者svn）
仓库放到了github  路径为/fanhualuo/config-repo
(2)，构建配置中心（config-server-git）
加入依赖
<dependencies>
	<dependency>
		<groupId>org.springframework.cloud</groupId>
		<artifactId>spring-cloud-config-server</artifactId>
	</dependency>
</dependencies>
创建Spring Boot的程序主类，并添加@EnableConfigServer注解，开启Spring Cloud Config的服务端功能。
application.yml中添加配置服务的基本信息以及Git仓库的相关信息
检查配置是否正确 路径访问说明：
/{application}/{profile}[/{label}]
/{application}-{profile}.yml
/{label}/{application}-{profile}.yml
/{application}-{profile}.properties
/{label}/{application}-{profile}.properties
上面的url会映射{application}-{profile}.properties对应的配置文件，其中{label}对应Git上不同的分支，默认为master。我们可以尝试构造不同的url来访问不同的配置内容，比如，要访问master分支，config-client应用的dev环境，就可以访问这个url：http://localhost:8880/config-client/dev/master，并获得如下返回：
(3)，构建客户端
加入依赖
<dependencies>
	<dependency>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-web</artifactId>
	</dependency>
	<dependency>
		<groupId>org.springframework.cloud</groupId>
		<artifactId>spring-cloud-starter-config</artifactId>
	</dependency>
</dependencies>
创建bootstrap.yml配置，来指定获取配置文件的config-server-git位置

通过url可以查看配置信息
http://localhost:2001/info

7，总结
我们使用Spring Cloud Netflix中的Eureka实现了服务注册中心以及服务注册与发现；而服务间通过Ribbon或Feign实现服务的消费以及均衡负载；通过Spring Cloud Config实现了应用多环境的外部化配置以及版本管理。为了使得服务集群更为健壮，使用Hystrix的融断机制来避免在微服务架构中个别服务出现异常时引起的故障蔓延。


8，服务网关
服务网关是微服务架构中一个不可或缺的部分。通过服务网关统一向外系统提供REST API的过程中，除了具备服务路由、均衡负载功能之外，它还具备了权限控制等功能。Spring Cloud Netflix中的Zuul就担任了这样的一个角色，为微服务架构提供了前门保护的作用，同时将权限控制这些较重的非业务逻辑内容迁移到服务路由层面，使得服务集群主体能够具备更高的可复用性和可测试性。

9，高可用服务注册中心
Eureka Server除了单点运行之外，还可以通过运行多个实例，并进行互相注册的方式来实现高可用的部署，所以我们只需要将Eureke Server配置其他可用的serviceUrl就能实现高可用部署。

创建两个服务注册中心server1，server2
(1)  server1的配置文件
server.port=8888
eureka.instance.hostname=server1
eureka.client.serviceUrl.defaultZone=http://server2:8889/eureka/
(2)  server2的配置文件
server.port=8889
eureka.instance.hostname=server2
eureka.client.serviceUrl.defaultZone=http://server1:8888/eureka/

(3)  在/etc/hosts文件中添加对server1和server2的转换
127.0.0.1 server1
127.0.0.1 server2

(4)  此时访问peer1的注册中心：http://localhost:8888/，如下图所示，我们可以看到registered-replicas中已经有peer2节点的eureka-server了。同样地，访问peer2的注册中心：http://localhost:8889/，能看到registered-replicas中已经有peer1节点，并且这些节点在可用分片（available-replicase）之中。我们也可以尝试关闭peer1，刷新http://localhost:8889/，可以看到peer1的节点变为了不可用分片（unavailable-replicas）。

